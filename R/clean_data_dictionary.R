#' Clean OFH Data Dictionary
#'
#' Cleans and standardizes an OFH data dictionary table by validating structure,
#' fixing data types, and ensuring consistent formatting.
#'
#' This function processes a data dictionary to:
#' 1. Validate required column structure
#' 2. Fix is_multi_select column to use TRUE/FALSE instead of TRUE/NA
#' 3. Correct column type documentation (columns documented as integer are actually strings)
#'
#' @param data_dictionary data.table containing data dictionary information with
#'   columns: entity, name, type, primary_key_type, coding_name,
#'   is_sparse_coding, is_multi_select, referenced_entity_field, relationship,
#'   folder_path, title, units, description, category, file, file_name, level,
#'   field_type, vcf_field, values
#'
#' @return data.table with cleaned data dictionary
#' @export
#'
#' @examples
#' \dontrun{
#' # Clean a data dictionary
#' # cleaned_dict <- clean_data_dictionary(my_data_dictionary)
#' }
clean_data_dictionary <- function(data_dictionary) {
  # Validate input
  if (!data.table::is.data.table(data_dictionary)) {
    rlang::abort("data_dictionary must be a data.table")
  }

  required_cols <- c(
    "entity",
    "name",
    "type",
    "primary_key_type",
    "coding_name",
    "is_sparse_coding",
    "is_multi_select",
    "referenced_entity_field",
    "relationship",
    "folder_path",
    "title",
    "units",
    "description",
    "category",
    "file",
    "file_name",
    "level",
    "field_type",
    "vcf_field",
    "values"
  )
  if (!all(required_cols %in% names(data_dictionary))) {
    missing_cols <- required_cols[!required_cols %in% names(data_dictionary)]
    rlang::abort(glue::glue(
      "data_dictionary missing required columns: {paste(missing_cols, collapse = ', ')}"
    ))
  }

  # Fix is_multi_select column: convert NA to FALSE and ensure TRUE/FALSE values
  # Previously was TRUE/NA, should be TRUE/FALSE
  data_dictionary[is.na(is_multi_select), is_multi_select := FALSE]

  # TODO - this might be stupid
  # Fix column type documentation: columns documented as integer are actually strings
  # The "type" column should contain string values like "string", "integer", "date", etc.
  # but were previously documented as integers in the documentation
  character_coded_codings <- c(
    "pid",
    "consent_version",
    "id",
    "questionnaire_version",
    "appointment_version",
    "event_property_1",
    "event_property_2",
    "event_property_3",
    "pseudonymised_avpid",
    "pseudonymised_tumourid",
    "row_id",
    "source_id",
    "source_table",
    "behaviour_coded",
    "behaviour_coded_desc",
    "behaviour_icd10_o2",
    "coding_system",
    "coding_system_desc",
    "dukes",
    "er_score",
    "er_status",
    "figo",
    "grade",
    "her2_status",
    "histology_coded",
    "histology_coded_desc",
    "imd_quintile",
    "laterality",
    "morph_coded",
    "morph_icd10_o2",
    "m_best",
    "n_best",
    "pr_score",
    "pr_status",
    "screendetected",
    "screeningstatuscosd_code",
    "screeningstatuscosd_name",
    "screeningstatusfull_code",
    "screeningstatusfull_name",
    "site_coded",
    "site_coded_3char",
    "site_coded_desc",
    "site_icd10_o2",
    "stage_best",
    "stage_best_system",
    "t_best",
    "chemo_all_drugs",
    "eventcode",
    "eventdesc",
    "imagingcode_nicip",
    "imagingcode_snomedct",
    "imagingdesc",
    "imagingsite",
    "opcs4_code",
    "opcs4_name",
    "pseudonymised_eventid",
    "radiocode",
    "radiodesc",
    "acuity",
    "arrival_mode",
    "arrival_time",
    "assessment_time",
    "attendance_category",
    "attendance_source",
    "chief_complaint",
    "code_cleaning_applied",
    "comorbidities_1",
    "comorbidities_10",
    "comorbidities_2",
    "comorbidities_3",
    "comorbidities_4",
    "comorbidities_5",
    "comorbidities_6",
    "comorbidities_7",
    "comorbidities_8",
    "comorbidities_9",
    "conclusion_time",
    "conveying_ambulance_trust_ofh",
    "decided_to_admit_time",
    "department_type",
    "departure_time",
    "diagnosis_code_1",
    "diagnosis_code_10",
    "diagnosis_code_11",
    "diagnosis_code_12",
    "diagnosis_code_2",
    "diagnosis_code_3",
    "diagnosis_code_4",
    "diagnosis_code_5",
    "diagnosis_code_6",
    "diagnosis_code_7",
    "diagnosis_code_8",
    "diagnosis_code_9",
    "diagnosis_qualifier_1",
    "diagnosis_qualifier_10",
    "diagnosis_qualifier_11",
    "diagnosis_qualifier_12",
    "diagnosis_qualifier_2",
    "diagnosis_qualifier_3",
    "diagnosis_qualifier_4",
    "diagnosis_qualifier_5",
    "diagnosis_qualifier_6",
    "diagnosis_qualifier_7",
    "diagnosis_qualifier_8",
    "diagnosis_qualifier_9",
    "discharge_destination",
    "discharge_follow_up",
    "discharge_status",
    "epikey",
    "injury_activity_status",
    "injury_activity_type",
    "injury_time",
    "investigation_code_1",
    "investigation_code_10",
    "investigation_code_11",
    "investigation_code_12",
    "investigation_code_2",
    "investigation_code_3",
    "investigation_code_4",
    "investigation_code_5",
    "investigation_code_6",
    "investigation_code_7",
    "investigation_code_8",
    "investigation_code_9",
    "investigation_time_1",
    "investigation_time_10",
    "investigation_time_11",
    "investigation_time_12",
    "investigation_time_2",
    "investigation_time_3",
    "investigation_time_4",
    "investigation_time_5",
    "investigation_time_6",
    "investigation_time_7",
    "investigation_time_8",
    "investigation_time_9",
    "period_length",
    "record_identifier",
    "referral_assessment_time_1",
    "referral_assessment_time_2",
    "referral_assessment_time_3",
    "referral_assessment_time_4",
    "referred_to_service_1",
    "referred_to_service_2",
    "referred_to_service_3",
    "referred_to_service_4",
    "seen_time",
    "treatment_code_1",
    "treatment_code_10",
    "treatment_code_11",
    "treatment_code_12",
    "treatment_code_2",
    "treatment_code_3",
    "treatment_code_4",
    "treatment_code_5",
    "treatment_code_6",
    "treatment_code_7",
    "treatment_code_8",
    "treatment_code_9",
    "treatment_function_code",
    "treatment_time_1",
    "treatment_time_10",
    "treatment_time_11",
    "treatment_time_12",
    "treatment_time_2",
    "treatment_time_3",
    "treatment_time_4",
    "treatment_time_5",
    "treatment_time_6",
    "treatment_time_7",
    "treatment_time_8",
    "treatment_time_9",
    "aearrivalmode",
    "aeattendcat",
    "aeattenddisp",
    "aedepttype",
    "aekey",
    "aerefsource",
    "arrivaltime",
    "concltime",
    "deptime",
    "diaga_01",
    "diaga_02",
    "diaga_03",
    "diaga_04",
    "diaga_05",
    "diaga_06",
    "diaga_07",
    "diaga_08",
    "diaga_09",
    "diaga_10",
    "diaga_11",
    "diaga_12",
    "diagscheme",
    "diags_01",
    "diags_02",
    "diags_03",
    "diags_04",
    "diags_05",
    "diags_06",
    "diags_07",
    "diags_08",
    "diags_09",
    "diags_10",
    "diags_11",
    "diags_12",
    "diag_01",
    "diag_02",
    "diag_03",
    "diag_04",
    "diag_05",
    "diag_06",
    "diag_07",
    "diag_08",
    "diag_09",
    "diag_10",
    "diag_11",
    "diag_12",
    "imd04_decile",
    "invest2_01",
    "invest2_02",
    "invest2_03",
    "invest2_04",
    "invest2_05",
    "invest2_06",
    "invest2_07",
    "invest2_08",
    "invest2_09",
    "invest2_10",
    "invest2_11",
    "invest2_12",
    "invest_01",
    "invest_02",
    "invest_03",
    "invest_04",
    "invest_05",
    "invest_06",
    "invest_07",
    "invest_08",
    "invest_09",
    "invest_10",
    "invest_11",
    "invest_12",
    "procode3_ofh",
    "protype",
    "susspellid",
    "treat_01",
    "treat_02",
    "treat_03",
    "treat_04",
    "treat_05",
    "treat_06",
    "treat_07",
    "treat_08",
    "treat_09",
    "treat_10",
    "treat_11",
    "treat_12",
    "trettime",
    "admimeth",
    "admincat",
    "admisorc",
    "bedyear",
    "carersi",
    "classpat",
    "diag_4_01",
    "diag_4_02",
    "diag_4_03",
    "diag_4_04",
    "diag_4_05",
    "diag_4_06",
    "diag_4_07",
    "diag_4_08",
    "diag_4_09",
    "diag_4_10",
    "diag_4_11",
    "diag_4_12",
    "diag_4_13",
    "diag_4_14",
    "diag_4_15",
    "diag_4_16",
    "diag_4_17",
    "diag_4_18",
    "diag_4_19",
    "diag_4_20",
    "disdest",
    "dismeth",
    "epidur",
    "epiorder",
    "firstreg",
    "intmanig",
    "mainspef",
    "operstat",
    "opertn_01",
    "opertn_02",
    "opertn_03",
    "opertn_04",
    "opertn_05",
    "opertn_06",
    "opertn_07",
    "opertn_08",
    "opertn_09",
    "opertn_10",
    "opertn_11",
    "opertn_12",
    "opertn_13",
    "opertn_14",
    "opertn_15",
    "opertn_16",
    "opertn_17",
    "opertn_18",
    "opertn_19",
    "opertn_20",
    "opertn_21",
    "opertn_22",
    "opertn_23",
    "opertn_24",
    "posopdur",
    "preopdur",
    "rttperstat",
    "spelbgin",
    "spelend",
    "susrecid",
    "tretspef",
    "attended",
    "attendkey",
    "firstatt",
    "outcome",
    "refsourc",
    "bsaprescriptionid",
    "chargestatus",
    "costcentreodscode_ofh",
    "costcentresubtype",
    "itemnic",
    "paidbnfcode",
    "paidbnfname",
    "paiddissallowedindicator",
    "paiddrugstrength",
    "paidflavourindicator",
    "paidformulation",
    "paidindicator",
    "paidsuppliername",
    "paiddmdcode",
    "prescribedbnfcode",
    "prescribedbnfname",
    "prescribedformulation",
    "prescribedmedicinestrength",
    "prescribeddmdcode",
    "s_cod_code_1",
    "s_cod_code_10",
    "s_cod_code_11",
    "s_cod_code_12",
    "s_cod_code_13",
    "s_cod_code_14",
    "s_cod_code_15",
    "s_cod_code_2",
    "s_cod_code_3",
    "s_cod_code_4",
    "s_cod_code_5",
    "s_cod_code_6",
    "s_cod_code_7",
    "s_cod_code_8",
    "s_cod_code_9",
    "s_underlying_cod_icd10",
    "country_at_reg",
    "region_at_reg",
    "msoa_at_reg",
    "lsoa_at_reg",
    "iz_at_reg",
    "plate",
    "genetic sex",
    "batch",
    "array manifest version",
    "gt"
  )
  data_dictionary[
    tolower(coding_name) %in% character_coded_codings,
    type := "string"
  ]

  return(data_dictionary)
}
