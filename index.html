<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Working with and on DNAnexus's Our Future Health Trusted Research Environment • ofhelper</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Working with and on DNAnexus's Our Future Health Trusted Research Environment">
<meta name="description" content="DNAnexus provides Trusted Research Environments (TREs) for several large population-based cohort studies, like the UK Biobank (UKB) and Our Future Health (OFH). For working on and with their TRE, they provide the `dx` Python utility for interacting with cloud environment. When working within R, this requires switching to a shell or wrapping calls in `system2()` or similar. This package provides several convenience wrappers to do this for you. Additionally, it enables submitting jobs with arbitrary R codes from your local session. Finally, several default workflows for OFH are provided.">
<meta property="og:description" content="DNAnexus provides Trusted Research Environments (TREs) for several large population-based cohort studies, like the UK Biobank (UKB) and Our Future Health (OFH). For working on and with their TRE, they provide the `dx` Python utility for interacting with cloud environment. When working within R, this requires switching to a shell or wrapping calls in `system2()` or similar. This package provides several convenience wrappers to do this for you. Additionally, it enables submitting jobs with arbitrary R codes from your local session. Finally, several default workflows for OFH are provided.">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">ofhelper</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="ofhelper">OFHelper<a class="anchor" aria-label="anchor" href="#ofhelper"></a>
</h1></div>
<!-- badges: start -->

<p>This is a collection of helper functions and utilities to make working on the DNAnexus-based <a href="https://ourfuturehealth.dnanexus.com/" class="external-link">Our Future Health TRE</a> more convenient. It provides wrapper functions around the <a href="https://github.com/dnanexus/dx-toolkit" class="external-link"><code>dx</code> utility</a> and should therefore not be exclusively useful for working with the specific TRE it was designed for, but general work on DNAnexus from within an interactive R session.</p>
<p>This project is in no way affiliated with DNAnexus. In fact, the author does not particularly enjoy working on their platform, hence this package.</p>
<p>Main use-cases are:</p>
<ul>
<li>Interact with the <code>dx</code> toolkit from within your R session, both locally and in a OFH TRE Jupyter session using convenience functions wrapping common calls to <code>dx</code>
</li>
<li>Submit R commands to a worker job without the need to interact with with the web interface of DNAnexus</li>
<li>Where relevant, the functions work exclusively with dependencies available on the <a href="https://documentation.dnanexus.com/user/jupyter-notebooks" class="external-link">OFH TRE JupyterLab workstation</a>
</li>
</ul>
<div class="section level2">
<h2 id="key-features">Key Features<a class="anchor" aria-label="anchor" href="#key-features"></a>
</h2>
<ul>
<li>
<strong>Launch a JupyterLab Session from your R command line</strong>
<ul>
<li><code><a href="reference/dx_launch_workstation.html">dx_launch_workstation()</a></code></li>
</ul>
</li>
<li>
<strong>Submit R jobs with custom scripts</strong>
<ul>
<li><code><a href="reference/dx_submit_r_job.html">dx_submit_r_job()</a></code></li>
</ul>
</li>
<li>
<strong>DNAnexus Operations</strong>:
<ul>
<li>Functions starting with: <code>dx_*</code>
</li>
<li>
<code><a href="reference/dx_run_cmd.html">dx_run_cmd()</a></code> can be used to execute arbitrary <code>dx</code> commands slightly cleaner than by using <code><a href="https://rdrr.io/r/base/system2.html" class="external-link">system2()</a></code> or similar</li>
<li>
<code>dx_upload</code> can be used to upload result files from a worker to the project space with the option to overwrite files with the same name</li>
</ul>
</li>
<li>
<strong>Decoding Workflows for raw OFH data</strong>
<ul>
<li><code><a href="reference/decode_single_select.html">decode_single_select()</a></code></li>
<li><code><a href="reference/decode_multi_select.html">decode_multi_select()</a></code></li>
<li><code><a href="reference/decode_raw_ofh_file.html">decode_raw_ofh_file()</a></code></li>
</ul>
</li>
<li>
<strong>Logging</strong>: <code>simple_logger()</code> due to none being available on OFH</li>
<li>
<strong>Instance-Type Selection</strong>:
<ul>
<li>
<code><a href="reference/find_tre_instance_type.html">find_tre_instance_type()</a></code> so you don’t have to check the rate card manually</li>
</ul>
</li>
</ul>
</div>
<div class="section level2">
<h2 id="portability">Portability<a class="anchor" aria-label="anchor" href="#portability"></a>
</h2>
<p>The package relies on the external python executable <code>dx</code>, so using this package on Windows will probably only work from within WSL. The package should work without issues on Unix-based operating system.</p>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<div class="section level3">
<h3 id="installing-dxpy">Installing <code>dxpy</code>
<a class="anchor" aria-label="anchor" href="#installing-dxpy"></a>
</h3>
<p>The external dependency this package provides wrappers for must be installed separately. Package managers like <code>uv</code> or <code>conda</code> can be used for this purpose. The location of the required binary can then be queried and passed to the initialization function.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co"># Using conda</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="ex">conda</span> create <span class="at">-n</span> dxpy python=3.10</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="ex">conda</span> activate dxpy</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="ex">pip</span> install dxpy</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="co"># Using uv</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="ex">uv</span> venv</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="ex">uv</span> pip install dxpy</span></code></pre></div>
<p>After activating the environment, check the path of the executable (requires the <code>whereis</code> utility).</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">whereis</span> dx</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="installing-ofhelper">Installing <code>ofhelper</code>
<a class="anchor" aria-label="anchor" href="#installing-ofhelper"></a>
</h3>
<p>Locally, you can install the packacke using:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"remotes"</span><span class="op">)</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"comp-med/r-ofhelper"</span><span class="op">)</span></span></code></pre></div>
<p>On the OFH TRE, you can upload the package using the <a href="https://dnanexus.gitbook.io/ofh/airlock/importing-files-into-a-restricted-project" class="external-link">Airlock system</a>, since no external packages can be installed and all development must take place in a vanilla Jupyter Notebook environment.</p>
<p>For this, a convenience function is provided (after installing the package locally) to create a single input string that can be then be written to a file to be submitted to the <code>Airlock</code> system. This is more convenient for the auditing process.</p>
<p>Locally, run the following command to create a string containing all functions. Write that to a file and upload it to the TRE.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># `ofhelper_string` contains all functions of this package. Submit those to the airlock.</span></span>
<span><span class="va">ofhelper_string</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/create_ofhelper_string.html">create_ofhelper_string</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/writeLines.html" class="external-link">writeLines</a></span><span class="op">(</span><span class="va">ofhelper_string</span>, <span class="st">"upload_this_via_the_airlock.txt"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="example-usage">Example Usage<a class="anchor" aria-label="anchor" href="#example-usage"></a>
</h2>
<div class="section level3">
<h3 id="initialization">Initialization<a class="anchor" aria-label="anchor" href="#initialization"></a>
</h3>
<p>Within R, you can parse your existing <code>dx</code> session, but it is important to first initialize with the <code><a href="reference/dx_init.html">dx_init()</a></code> function.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"ofhelper"</span>)</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="co"># required if not in $PATH</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>my_dx_binary <span class="ot">&lt;-</span> <span class="st">"/PATH/TO/dx"</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a> <span class="co"># required for initialization. Can be changed afterwards</span></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>my_dx_project <span class="ot">&lt;-</span> <span class="st">"project-12345"</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a><span class="co"># Required if not logged in already (outside of R)</span></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>my_dx_access_token <span class="ot">&lt;-</span> <span class="st">"..."</span></span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a><span class="co"># Optional, will use `/` otherwise </span></span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a>my_dx_project_dir <span class="ot">=</span> <span class="er">&lt;</span><span class="sc">-</span> <span class="st">"/some/dnanexus/directory/"</span></span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a><span class="co"># Some Jupyter sessions do not provide internet access, so you can disable the</span></span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a><span class="co"># connectivity check here</span></span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a>do_connectivity_check <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a><span class="co"># set up the package using this function</span></span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a><span class="fu">dx_init</span>(</span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a>  <span class="at">dx_binary =</span> my_dx_binary,</span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a>  <span class="at">dx_project =</span> my_dx_project,</span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a>  <span class="at">dx_token =</span> my_dx_access_token,</span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a>  <span class="at">dx_path =</span> my_dx_project_dir,</span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a>  <span class="at">check_connectivity =</span> do_connectivity_check </span>
<span id="cb5-26"><a href="#cb5-26" tabindex="-1"></a>)</span></code></pre></div>
<p>Afterwards, you can check the status of the package by running <code>get_dx_cache()</code>. This informs you about the status available to your R session and this package’s functions (i.e. the package’s cache of <code>dx</code>’s status). To directly check the status of <code>dx</code>, run <code><a href="reference/dx_get_env.html">dx_get_env()</a></code>, which simply parses the output of <code>dx env</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">get_dx_cache</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "/PATH/TO/dx"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $dx_project_id</span></span>
<span><span class="co">#&gt; [1] "project-12345"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $dx_project_name</span></span>
<span><span class="co">#&gt; [1] "YOUR_PROJECT_NAME"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $dx_path</span></span>
<span><span class="co">#&gt; [1] "/some/dnanexus/directory/"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $dx_user</span></span>
<span><span class="co">#&gt; [1] "your_user_name"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $dx_server_host</span></span>
<span><span class="co">#&gt; [1] "api.dnanexus.com"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $dx_initialized</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="launching-workstations">Launching Workstations<a class="anchor" aria-label="anchor" href="#launching-workstations"></a>
</h3>
<p>To launch a workstation to work in interactively, use <code><a href="reference/dx_launch_workstation.html">dx_launch_workstation()</a></code>. You can also get the worker job URL using <code><a href="reference/get_workstation_worker_url.html">get_workstation_worker_url()</a></code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_instance</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/find_tre_instance_type.html">find_tre_instance_type</a></span><span class="op">(</span></span>
<span>  required_n_cpus <span class="op">=</span> <span class="fl">8</span>,</span>
<span>  required_gb_ram <span class="op">=</span> <span class="fl">64</span>, </span>
<span>  required_gb_disk_storage <span class="op">=</span> <span class="fl">256</span></span>
<span><span class="op">)</span></span>
<span><span class="va">my_worker_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/dx_launch_workstation.html">dx_launch_workstation</a></span><span class="op">(</span></span>
<span>  session_name <span class="op">=</span> <span class="st">"my_workstation"</span>, </span>
<span>  instance_type <span class="op">=</span> <span class="va">my_instance</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># When the workstation is booted up, this will return the URL to use for interactive work</span></span>
<span><span class="fu"><a href="reference/get_workstation_worker_url.html">get_workstation_worker_url</a></span><span class="op">(</span><span class="va">my_worker_id</span><span class="op">)</span></span>
<span><span class="co">#&gt; https://...</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="submitting-r-scripts">Submitting R Scripts<a class="anchor" aria-label="anchor" href="#submitting-r-scripts"></a>
</h3>
<p>To submit an R script from your local environment, you can use the <code><a href="reference/dx_submit_r_job.html">dx_submit_r_job()</a></code> function. This simplifies to required workflow by not having to paste code to an interactive session the code changes slightly.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create script you'd want to execute on DNAnexus</span></span>
<span><span class="va">script_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"r_job"</span>, fileext <span class="op">=</span> <span class="st">".R"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/writeLines.html" class="external-link">writeLines</a></span><span class="op">(</span><span class="st">"sessionInfo()"</span>, <span class="va">script_file</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Submit the script - see the function documentation for the additional parameters</span></span>
<span><span class="fu"><a href="reference/dx_submit_r_job.html">dx_submit_r_job</a></span><span class="op">(</span></span>
<span>  script_path <span class="op">=</span> <span class="va">script_file</span>, </span>
<span>  include_ofhelper <span class="op">=</span> <span class="cn">F</span>, </span>
<span>  tag <span class="op">=</span> <span class="st">"test"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="decoding-raw-data">Decoding Raw Data<a class="anchor" aria-label="anchor" href="#decoding-raw-data"></a>
</h3>
<p>Before analysing from the SPARK database, data needs to be prepared for analysis. These steps include:</p>
<ol style="list-style-type: decimal">
<li>Export (raw) data from the database</li>
<li>Decode data (replace coded values with meaning) where applicable</li>
<li>Clean and explore coded data</li>
<li>Transform data with multiple items per participant and variable</li>
<li>Deriving new variables for analysis &amp; mapping terms to existing ontologies</li>
</ol>
<p>For exporting raw data and decoding it, the functons <code><a href="reference/export_entities.html">export_entities()</a></code> and <code><a href="reference/decode_raw_ofh_file.html">decode_raw_ofh_file()</a></code> are provided.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="co"># Todo</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="co"># ...</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="dependencies">Dependencies<a class="anchor" aria-label="anchor" href="#dependencies"></a>
</h2>
<p>Dependencies of functions that can be used are restricted to the packages available on the OFH TRE. Some functions are designed to be run for your local environment and might include additional dependencies.</p>
<ul>
<li><code>data.table</code></li>
<li><code>fs</code></li>
<li><code>rlang</code></li>
<li><code>glue</code></li>
</ul>
</div>
<div class="section level2">
<h2 id="todos">TODOs<a class="anchor" aria-label="anchor" href="#todos"></a>
</h2>
<ul>
<li>Look for TODO tags in the functions!</li>
<li>Tests are mostly mock-tests right now</li>
<li>Integration tests with <code>dx</code> are not present yet</li>
<li>Due to the straight forward nature of the package, most function documentation was generated using an LLM, so expect errors</li>
</ul>
</div>
</div>
  </main><aside class="col-md-3"><div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small>GPL (&gt;= 3)</small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing ofhelper</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Carl Beuchel <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0003-3437-9963" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a>  </li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental" class="external-link"><img src="https://img.shields.io/badge/lifecycle-experimental-orange.svg" alt="Lifecycle: experimental"></a></li>
<li><a href="https://github.com/comp-med/r-ofhelper/actions/workflows/R-CMD-check.yaml" class="external-link"><img src="https://github.com/comp-med/r-ofhelper/actions/workflows/R-CMD-check.yaml/badge.svg" alt="R-CMD-check"></a></li>
</ul>
</div>

  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Carl Beuchel.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
