# OFHelper

This is a collection of helper functions and utilities to make working
on the DNAnexus-based [Our Future Health
TRE](https://ourfuturehealth.dnanexus.com/) more convenient. It provides
wrapper functions around the [`dx`
utility](https://github.com/dnanexus/dx-toolkit) and should therefore
not be exclusively useful for working with the specific TRE it was
designed for, but general work on DNAnexus from within an interactive R
session.

This project is in no way affiliated with DNAnexus. In fact, the author
does not particularly enjoy working on their platform, hence this
package.

Main use-cases are:

- Interact with the `dx` toolkit from within your R session, both
  locally and in a OFH TRE Jupyter session using convenience functions
  wrapping common calls to `dx`
- Submit R commands to a worker job without the need to interact with
  with the web interface of DNAnexus
- Where relevant, the functions work exclusively with dependencies
  available on the [OFH TRE JupyterLab
  workstation](https://documentation.dnanexus.com/user/jupyter-notebooks)

## Key Features

Function documentation is also available at
[`https://comp-med.github.io/r-ofhelper/`](https://comp-med.github.io/r-ofhelper/).

- **Launch a JupyterLab Session from your R command line**
  - [`dx_launch_workstation()`](https://comp-med.github.io/r-ofhelper/reference/dx_launch_workstation.md)
- **Submit R jobs with custom scripts**
  - [`dx_submit_r_job()`](https://comp-med.github.io/r-ofhelper/reference/dx_submit_r_job.md)
- **DNAnexus Operations**:
  - Functions starting with: `dx_*`
  - [`dx_run_cmd()`](https://comp-med.github.io/r-ofhelper/reference/dx_run_cmd.md)
    can be used to execute arbitrary `dx` commands slightly cleaner than
    by using [`system2()`](https://rdrr.io/r/base/system2.html) or
    similar
  - `dx_upload` can be used to upload result files from a worker to the
    project space with the option to overwrite files with the same name
- **Decoding Workflows for raw OFH data**
  - [`decode_single_select()`](https://comp-med.github.io/r-ofhelper/reference/decode_single_select.md)
  - [`decode_multi_select()`](https://comp-med.github.io/r-ofhelper/reference/decode_multi_select.md)
  - [`decode_raw_ofh_file()`](https://comp-med.github.io/r-ofhelper/reference/decode_raw_ofh_file.md)
- **Logging**: `simple_logger()` due to none being available on OFH
- **Instance-Type Selection**:
  - [`find_tre_instance_type()`](https://comp-med.github.io/r-ofhelper/reference/find_tre_instance_type.md)
    so you don’t have to check the rate card manually

## Portability

The package relies on the external python executable `dx`, so using this
package on Windows will probably only work from within WSL. The package
should work without issues on Unix-based operating system.

## Installation

### Installing `dxpy`

The external dependency this package provides wrappers for must be
installed separately. Package managers like `uv` or `conda` can be used
for this purpose. The location of the required binary can then be
queried and passed to the initialization function.

``` bash
# Using conda
conda create -n dxpy python=3.10
conda activate dxpy
pip install dxpy

# Using uv
uv venv
uv pip install dxpy
```

After activating the environment, check the path of the executable
(requires the `whereis` utility).

``` bash
whereis dx
```

### Installing `ofhelper`

Locally, you can install the packacke using:

``` r
install.packages("remotes")
remotes::install_github("comp-med/r-ofhelper")
```

On the OFH TRE, you can upload the package using the [Airlock
system](https://dnanexus.gitbook.io/ofh/airlock/importing-files-into-a-restricted-project),
since no external packages can be installed and all development must
take place in a vanilla Jupyter Notebook environment.

For this, a convenience function is provided (after installing the
package locally) to create a single input string that can be then be
written to a file to be submitted to the `Airlock` system. This is more
convenient for the auditing process.

Locally, run the following command to create a string containing all
functions. Write that to a file and upload it to the TRE.

``` r
# `ofhelper_string` contains all functions of this package. Submit those to the airlock.
ofhelper_string <- create_ofhelper_string()
writeLines(ofhelper_string, "upload_this_via_the_airlock.txt")
```

## Example Usage

### Initialization

Within R, you can parse your existing `dx` session, but it is important
to first initialize with the
[`dx_init()`](https://comp-med.github.io/r-ofhelper/reference/dx_init.md)
function.

``` r
library("ofhelper")

# required if not in $PATH
my_dx_binary <- "/PATH/TO/dx"

 # required for initialization. Can be changed afterwards
my_dx_project <- "project-12345"

# Required if not logged in already (outside of R)
my_dx_access_token <- "..."

# Optional, will use `/` otherwise 
my_dx_project_dir = <- "/some/dnanexus/directory/"

# Some Jupyter sessions do not provide internet access, so you can disable the
# connectivity check here
do_connectivity_check = TRUE

# set up the package using this function
dx_init(
  dx_binary = my_dx_binary,
  dx_project = my_dx_project,
  dx_token = my_dx_access_token,
  dx_path = my_dx_project_dir,
  check_connectivity = do_connectivity_check 
)
```

Afterwards, you can check the status of the package by running
`get_dx_cache()`. This informs you about the status available to your R
session and this package’s functions (i.e. the package’s cache of `dx`’s
status). To directly check the status of `dx`, run
[`dx_get_env()`](https://comp-med.github.io/r-ofhelper/reference/dx_get_env.md),
which simply parses the output of `dx env`.

``` r
get_dx_cache()
#> [1] "/PATH/TO/dx"
#> 
#> $dx_project_id
#> [1] "project-12345"
#> 
#> $dx_project_name
#> [1] "YOUR_PROJECT_NAME"
#> 
#> $dx_path
#> [1] "/some/dnanexus/directory/"
#> 
#> $dx_user
#> [1] "your_user_name"
#> 
#> $dx_server_host
#> [1] "api.dnanexus.com"
#> 
#> $dx_initialized
#> [1] TRUE
```

### Launching Workstations

To launch a workstation to work in interactively, use
[`dx_launch_workstation()`](https://comp-med.github.io/r-ofhelper/reference/dx_launch_workstation.md).
You can also get the worker job URL using
[`get_workstation_worker_url()`](https://comp-med.github.io/r-ofhelper/reference/get_workstation_worker_url.md).

``` r
my_instance <- find_tre_instance_type(
  required_n_cpus = 8,
  required_gb_ram = 64, 
  required_gb_disk_storage = 256
)
my_worker_id <- dx_launch_workstation(
  session_name = "my_workstation", 
  instance_type = my_instance
)

# When the workstation is booted up, this will return the URL to use for interactive work
get_workstation_worker_url(my_worker_id)
#> https://...
```

### Submitting R Scripts

To submit an R script from your local environment, you can use the
[`dx_submit_r_job()`](https://comp-med.github.io/r-ofhelper/reference/dx_submit_r_job.md)
function. This simplifies to required workflow by not having to paste
code to an interactive session the code changes slightly.

``` r
# Create script you'd want to execute on DNAnexus
script_file <- tempfile(pattern = "r_job", fileext = ".R")
writeLines("sessionInfo()", script_file)

# Submit the script - see the function documentation for the additional parameters
dx_submit_r_job(
  script_path = script_file, 
  include_ofhelper = F, 
  tag = "test"
)
```

### Decoding Raw Data

Before analysing from the SPARK database, data needs to be prepared for
analysis. These steps include:

1.  Export (raw) data from the database
2.  Decode data (replace coded values with meaning) where applicable
3.  Clean and explore coded data
4.  Transform data with multiple items per participant and variable
5.  Deriving new variables for analysis & mapping terms to existing
    ontologies

For exporting raw data and decoding it, the functons
[`export_entities()`](https://comp-med.github.io/r-ofhelper/reference/export_entities.md)
and
[`decode_raw_ofh_file()`](https://comp-med.github.io/r-ofhelper/reference/decode_raw_ofh_file.md)
are provided.

``` bash
# Todo
# ...
```

## Dependencies

Dependencies of functions that can be used are restricted to the
packages available on the OFH TRE. Some functions are designed to be run
for your local environment and might include additional dependencies.

- `data.table`
- `fs`
- `rlang`
- `glue`

## TODOs

- Look for TODO tags in the functions!
- Tests are mostly mock-tests right now
- Integration tests with `dx` are not present yet
- Due to the straight forward nature of the package, most function
  documentation was generated using an LLM, so expect errors

# Package index

## All functions

- [`clean_codings_table()`](https://comp-med.github.io/r-ofhelper/reference/clean_codings_table.md)
  : Clean OFH Codings Table
- [`clean_data_dictionary()`](https://comp-med.github.io/r-ofhelper/reference/clean_data_dictionary.md)
  : Clean OFH Data Dictionary
- [`correct_column_type()`](https://comp-med.github.io/r-ofhelper/reference/correct_column_type.md)
  : Correct Data Column Type
- [`create_cmd_input_string()`](https://comp-med.github.io/r-ofhelper/reference/create_cmd_input_string.md)
  : Create Command Input String for Jupyter Workstation
- [`create_ofhelper_string()`](https://comp-med.github.io/r-ofhelper/reference/create_ofhelper_string.md)
  : Create Complete ofhelper Package Source String
- [`decode_multi_select()`](https://comp-med.github.io/r-ofhelper/reference/decode_multi_select.md)
  : Decode Multi-Select Variables
- [`decode_ofh_variable()`](https://comp-med.github.io/r-ofhelper/reference/decode_ofh_variable.md)
  : Decode OFH Variable
- [`decode_raw_ofh_file()`](https://comp-med.github.io/r-ofhelper/reference/decode_raw_ofh_file.md)
  : Decode Raw OFH Data File
- [`decode_single_select()`](https://comp-med.github.io/r-ofhelper/reference/decode_single_select.md)
  : Decode Single-Select Variables
- [`dx_auth()`](https://comp-med.github.io/r-ofhelper/reference/dx_auth.md)
  : Authenticate with DNAnexus
- [`dx_check()`](https://comp-med.github.io/r-ofhelper/reference/dx_check.md)
  : Check DNAnexus Environment Status
- [`dx_check_auth()`](https://comp-med.github.io/r-ofhelper/reference/dx_check_auth.md)
  : Check DNAnexus Authentication
- [`dx_check_binary()`](https://comp-med.github.io/r-ofhelper/reference/dx_check_binary.md)
  : Check DNAnexus Binary
- [`dx_check_connection()`](https://comp-med.github.io/r-ofhelper/reference/dx_check_connection.md)
  : Check DNAnexus API Connectivity
- [`dx_check_path()`](https://comp-med.github.io/r-ofhelper/reference/dx_check_path.md)
  : Check DNAnexus Path
- [`dx_check_project()`](https://comp-med.github.io/r-ofhelper/reference/dx_check_project.md)
  : Check DNAnexus Project
- [`dx_clear_env()`](https://comp-med.github.io/r-ofhelper/reference/dx_clear_env.md)
  : Clear DNAnexus Environment
- [`dx_download()`](https://comp-med.github.io/r-ofhelper/reference/dx_download.md)
  : Download Files from DNAnexus
- [`dx_file_exists()`](https://comp-med.github.io/r-ofhelper/reference/dx_file_exists.md)
  : Check if a File Exists on DNAnexus
- [`dx_find_projects()`](https://comp-med.github.io/r-ofhelper/reference/dx_find_projects.md)
  : Find DNAnexus Projects
- [`dx_get_env()`](https://comp-med.github.io/r-ofhelper/reference/dx_get_env.md)
  : Get DNAnexus Environment Information
- [`dx_init()`](https://comp-med.github.io/r-ofhelper/reference/dx_init.md)
  : Initialize DNAnexus Environment
- [`dx_is_initialized()`](https://comp-med.github.io/r-ofhelper/reference/dx_is_initialized.md)
  : Check if DNAnexus is Initialized
- [`dx_launch_workstation()`](https://comp-med.github.io/r-ofhelper/reference/dx_launch_workstation.md)
  : Launch a DNAnexus Workstation Session
- [`dx_ls()`](https://comp-med.github.io/r-ofhelper/reference/dx_ls.md)
  : List Contents of DNAnexus Directory
- [`dx_remount_project()`](https://comp-med.github.io/r-ofhelper/reference/dx_remount_project.md)
  : Remount DNAnexus Project
- [`dx_run_cmd()`](https://comp-med.github.io/r-ofhelper/reference/dx_run_cmd.md)
  : Run Arbitrary DX Commands
- [`dx_set_binary()`](https://comp-med.github.io/r-ofhelper/reference/dx_set_binary.md)
  : Set DNAnexus Binary Path
- [`dx_set_env()`](https://comp-med.github.io/r-ofhelper/reference/dx_set_env.md)
  : Set DNAnexus Environment Cache
- [`dx_set_path()`](https://comp-med.github.io/r-ofhelper/reference/dx_set_path.md)
  : Set DNAnexus Path
- [`dx_set_project()`](https://comp-med.github.io/r-ofhelper/reference/dx_set_project.md)
  : Set DNAnexus Project
- [`dx_submit_r_job()`](https://comp-med.github.io/r-ofhelper/reference/dx_submit_r_job.md)
  : Submit R Script as DNAnexus Job
- [`dx_upload()`](https://comp-med.github.io/r-ofhelper/reference/dx_upload.md)
  : Upload Files to DNAnexus
- [`explode_multi_select()`](https://comp-med.github.io/r-ofhelper/reference/explode_multi_select.md)
  : Explode Multi-Select Variables into Dummy Codes
- [`export_entities()`](https://comp-med.github.io/r-ofhelper/reference/export_entities.md)
  : Export Entities from DNAnexus
- [`find_tre_instance_type()`](https://comp-med.github.io/r-ofhelper/reference/find_tre_instance_type.md)
  : Find Suitable DNAnexus Instance Type
- [`get_workstation_worker_url()`](https://comp-med.github.io/r-ofhelper/reference/get_workstation_worker_url.md)
  : Get Workstation Worker URL
- [`rate_card`](https://comp-med.github.io/r-ofhelper/reference/rate_card.md)
  : Our Future Health TRE rate card
- [`tre_rate_card()`](https://comp-med.github.io/r-ofhelper/reference/tre_rate_card.md)
  : Get TRE Rate Card

